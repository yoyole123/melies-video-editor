"use strict";var q=Object.create;var l=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var M=Object.getPrototypeOf,j=Object.prototype.hasOwnProperty;var V=(t,e)=>{for(var r in e)l(t,r,{get:e[r],enumerable:!0})},C=(t,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of L(e))!j.call(t,n)&&n!==r&&l(t,n,{get:()=>e[n],enumerable:!(s=v(e,n))||s.enumerable});return t};var X=(t,e,r)=>(r=t!=null?q(M(t)):{},C(e||!t||!t.__esModule?l(r,"default",{value:t,enumerable:!0}):r,t)),J=t=>C(l({},"__esModule",{value:!0}),t);var at={};V(at,{handler:()=>ot});module.exports=J(at);var A=require("node:crypto"),E=require("@aws-sdk/client-s3"),B=require("@aws-sdk/client-dynamodb"),g=require("@aws-sdk/lib-dynamodb"),x=require("@aws-sdk/client-sqs"),P=require("@aws-sdk/s3-request-presigner");var I=X(require("node:crypto")),y=require("@aws-sdk/client-secrets-manager"),H=new y.SecretsManagerClient({}),N=null;async function W(t){return N||(N=(async()=>{let r=(await H.send(new y.GetSecretValueCommand({SecretId:t}))).SecretString??"";if(!r)throw new Error("Signing secret is empty.");return r})()),N}function $(t,e){return I.default.createHmac("sha256",t).update(e).digest("hex")}function Q(t,e){let r=Buffer.from(String(t||""),"hex"),s=Buffer.from(String(e||""),"hex");return r.length===0||s.length===0||r.length!==s.length?!1:I.default.timingSafeEqual(r,s)}async function D(t){let{signingSecretArn:e,timestampHeader:r,signatureHeader:s,method:n,path:o,rawBody:S,maxSkewSeconds:c}=t;if(!r||!s)throw new Error("Missing request signature headers.");let a=Number(r);if(!Number.isFinite(a))throw new Error("Invalid x-base44-timestamp.");let i=Date.now();if(Math.abs(i-a)/1e3>c)throw new Error("Request timestamp is outside the allowed window.");let f=await W(e),m=`${a}.${n.toUpperCase()}.${o}.${S}`,p=$(f,m);if(!Q(p,s))throw new Error("Invalid request signature.")}function z(t){let e=t?.editorData;if(!Array.isArray(e))throw new Error("`timeline.editorData` must be an array.")}function T(t){return z(t),t.editorData}var U=new E.S3Client({}),_=g.DynamoDBDocumentClient.from(new B.DynamoDBClient({})),F=new x.SQSClient({}),O=process.env.ASSETS_BUCKET??"",R=process.env.EXPORTS_BUCKET??"",h=process.env.JOBS_TABLE??"",G=process.env.QUEUE_URL??"",K=process.env.SIGNING_SECRET_ARN??"",Z=Number(process.env.SIGNING_MAX_SKEW_SECONDS??300),Y=Number(process.env.PRESIGN_UPLOAD_EXPIRES_SECONDS??900),tt=Number(process.env.PRESIGN_DOWNLOAD_EXPIRES_SECONDS??900),et=Number(process.env.JOB_TTL_SECONDS??10080*60);function d(t,e){return{statusCode:t,headers:{"content-type":"application/json; charset=utf-8","cache-control":"no-store"},body:JSON.stringify(e)}}function b(t){let e=t.body??"";return e?t.isBase64Encoded?Buffer.from(e,"base64").toString("utf8"):e:""}function rt(){let t=[["ASSETS_BUCKET",O],["EXPORTS_BUCKET",R],["JOBS_TABLE",h],["QUEUE_URL",G],["SIGNING_SECRET_ARN",K]].filter(([,e])=>!e);if(t.length)throw new Error(`Missing env vars: ${t.map(([e])=>e).join(", ")}`)}function st(t,e){return e.startsWith("/export")}async function nt(t){let e=t.requestContext.http.method.toUpperCase(),r=t.rawPath;if(!st(e,r))return;let s=t.headers["x-base44-timestamp"]??t.headers["X-Base44-Timestamp"],n=t.headers["x-base44-signature"]??t.headers["X-Base44-Signature"];await D({signingSecretArn:K,timestampHeader:s,signatureHeader:n,method:e,path:r,rawBody:b(t),maxSkewSeconds:Z})}async function ot(t){try{rt();let e=t.requestContext.http.method.toUpperCase(),r=t.rawPath;if(e==="GET"&&r==="/health")return d(200,{ok:!0});if(await nt(t),e==="POST"&&r==="/export/presign"){let n=b(t),o=JSON.parse(n||"{}"),S=Array.isArray(o.assets)?o.assets:[],c=[];for(let a of S){let i=String(a?.src??"");if(!i)continue;let u=String(a?.ext??""),f=u&&u.startsWith(".")&&u.length<=10?u:"",m=`assets/${(0,A.randomUUID)()}${f}`,p=a?.contentType?String(a.contentType):"application/octet-stream",w=new E.PutObjectCommand({Bucket:O,Key:m,ContentType:p}),k=await(0,P.getSignedUrl)(U,w,{expiresIn:Y});c.push({src:i,s3Key:m,uploadUrl:k})}return d(200,{uploads:c})}if(e==="POST"&&r==="/export"){let n=b(t),o=JSON.parse(n||"{}"),S=T(o.timeline),c=Array.isArray(o.assets)?o.assets:[],a=new Map;for(let m of c){let p=String(m?.src??""),w=String(m?.s3Key??"");!p||!w||a.set(p,w)}let i=(0,A.randomUUID)(),u=Date.now(),f=Math.floor((u+et*1e3)/1e3);return await _.send(new g.PutCommand({TableName:h,Item:{jobId:i,status:"QUEUED",createdAt:u,updatedAt:u,expiresAt:f},ConditionExpression:"attribute_not_exists(jobId)"})),await F.send(new x.SendMessageCommand({QueueUrl:G,MessageBody:JSON.stringify({jobId:i,timeline:o.timeline,assets:[...a.entries()].map(([m,p])=>({src:m,s3Key:p}))})})),await _.send(new g.UpdateCommand({TableName:h,Key:{jobId:i},UpdateExpression:"SET #s = :s, updatedAt = :u",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":"QUEUED",":u":Date.now()}})),d(200,{jobId:i})}let s=r.match(/^\/export\/(?<jobId>[a-zA-Z0-9-]+)$/);if(e==="GET"&&s?.groups?.jobId){let n=s.groups.jobId,o=await _.send(new g.GetCommand({TableName:h,Key:{jobId:n}}));if(!o.Item)return d(404,{error:"Job not found."});let S=String(o.Item.status??"UNKNOWN"),c=o.Item.outputKey?String(o.Item.outputKey):null,a=null;if(S==="SUCCEEDED"&&c){let i=new E.GetObjectCommand({Bucket:R,Key:c});a=await(0,P.getSignedUrl)(U,i,{expiresIn:tt})}return d(200,{jobId:n,status:S,error:o.Item.error??null,outputKey:c,downloadUrl:a})}return d(404,{error:"Not found."})}catch(e){let r=e instanceof Error?e.message:String(e),s=r.toLowerCase();return s.includes("signature")||s.includes("x-base44-timestamp")||s.includes("timestamp")?d(401,{error:r}):s.startsWith("missing env vars")?d(500,{error:"Server misconfiguration."}):d(400,{error:r})}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
